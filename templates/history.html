{% extends "base.html" %}

{% block title %}Analysis History - Mango Disease Detection{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 mb-2">
                        <i class="fas fa-history text-primary me-3"></i>
                        Analysis History
                    </h1>
                    <p class="text-muted">View and manage your previous disease detection analyses</p>
                </div>
                <div>
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>New Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by filename or disease...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="diseaseFilter">
                                <option value="">All Diseases</option>
                                <option value="Healthy">Healthy</option>
                                <option value="Anthracnose">Anthracnose</option>
                                <option value="Bacterial_Canker">Bacterial Canker</option>
                                <option value="Cutting_Weevil">Cutting Weevil</option>
                                <option value="Die_Back">Die Back</option>
                                <option value="Gall_Midge">Gall Midge</option>
                                <option value="Powdery_Mildew">Powdery Mildew</option>
                                <option value="Sooty_Mould">Sooty Mould</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="confidenceFilter">
                                <option value="">All Confidence Levels</option>
                                <option value="high">High (>80%)</option>
                                <option value="medium">Medium (50-80%)</option>
                                <option value="low">Low (<50%)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ analyses|length }}</h3>
                    <p class="text-muted mb-0">Total Analyses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    {% set healthy_count = analyses | selectattr('predicted_class', 'equalto', 'Healthy') | list | length %}
                    <h3 class="text-success">{{ healthy_count }}</h3>
                    <p class="text-muted mb-0">Healthy Leaves</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    {% set diseased_count = analyses | rejectattr('predicted_class', 'equalto', 'Healthy') | list | length %}
                    <h3 class="text-warning">{{ diseased_count }}</h3>
                    <p class="text-muted mb-0">Diseased Leaves</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    {% set avg_confidence = (analyses | sum(attribute='confidence') / analyses|length * 100) if analyses else 0 %}
                    <h3 class="text-info">{{ "%.1f"|format(avg_confidence) }}%</h3>
                    <p class="text-muted mb-0">Avg Confidence</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis History Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Recent Analyses
                        <span class="badge bg-primary ms-2" id="resultCount">{{ analyses|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if analyses %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="historyTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Image</th>
                                        <th>Filename</th>
                                        <th>Predicted Disease</th>
                                        <th>Confidence</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for analysis in analyses %}
                                    <tr class="analysis-row" 
                                        data-disease="{{ analysis.predicted_class }}" 
                                        data-confidence="{{ analysis.confidence }}"
                                        data-filename="{{ analysis.filename }}">
                                        <td>
                                            <span class="badge bg-secondary">#{{ analysis.id }}</span>
                                        </td>
                                        <td>
                                            <div style="width: 50px; height: 50px; overflow: hidden; border-radius: 8px;">
                                                <div class="bg-light d-flex align-items-center justify-content-center h-100">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ analysis.filename }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge {% if analysis.predicted_class == 'Healthy' %}bg-success{% else %}bg-warning{% endif %}">
                                                {{ analysis.predicted_class.replace('_', ' ') }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="height: 8px; width: 60px;">
                                                    <div class="progress-bar 
                                                        {% if analysis.confidence > 0.8 %}bg-success
                                                        {% elif analysis.confidence > 0.5 %}bg-warning
                                                        {% else %}bg-danger{% endif %}" 
                                                        style="width: {{ analysis.confidence * 100 }}%">
                                                    </div>
                                                </div>
                                                <small class="text-muted">{{ "%.1f"|format(analysis.confidence * 100) }}%</small>
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ analysis.created_at.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="viewAnalysis({{ analysis.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-info" onclick="explainAnalysis({{ analysis.id }})">
                                                    <i class="fas fa-search-plus"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteAnalysis({{ analysis.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination would go here if needed -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <small class="text-muted">
                                    Showing {{ analyses|length }} of {{ analyses|length }} analyses
                                </small>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary" onclick="exportHistory()">
                                    <i class="fas fa-download me-2"></i>Export History
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-history fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Analysis History</h5>
                            <p class="text-muted">You haven't performed any analyses yet.</p>
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Start Your First Analysis
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Details Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Analysis Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="analysisModalBody">
                <!-- Details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="reanalyzeImage()">
                    <i class="fas fa-redo me-2"></i>Reanalyze
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentAnalysisId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    setupFilters();
});

// Setup filter functionality
function setupFilters() {
    const searchInput = document.getElementById('searchInput');
    const diseaseFilter = document.getElementById('diseaseFilter');
    const confidenceFilter = document.getElementById('confidenceFilter');

    // Add event listeners
    searchInput.addEventListener('input', applyFilters);
    diseaseFilter.addEventListener('change', applyFilters);
    confidenceFilter.addEventListener('change', applyFilters);
}

// Apply filters to the table
function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const diseaseFilter = document.getElementById('diseaseFilter').value;
    const confidenceFilter = document.getElementById('confidenceFilter').value;
    
    const rows = document.querySelectorAll('.analysis-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const filename = row.dataset.filename.toLowerCase();
        const disease = row.dataset.disease;
        const confidence = parseFloat(row.dataset.confidence);
        
        let show = true;
        
        // Search filter
        if (searchTerm && !filename.includes(searchTerm) && !disease.toLowerCase().includes(searchTerm)) {
            show = false;
        }
        
        // Disease filter
        if (diseaseFilter && disease !== diseaseFilter) {
            show = false;
        }
        
        // Confidence filter
        if (confidenceFilter) {
            if (confidenceFilter === 'high' && confidence <= 0.8) show = false;
            if (confidenceFilter === 'medium' && (confidence <= 0.5 || confidence > 0.8)) show = false;
            if (confidenceFilter === 'low' && confidence > 0.5) show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Update result count
    document.getElementById('resultCount').textContent = visibleCount;
}

// Clear all filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('diseaseFilter').value = '';
    document.getElementById('confidenceFilter').value = '';
    applyFilters();
}

// View analysis details
function viewAnalysis(analysisId) {
    currentAnalysisId = analysisId;
    
    // In a real implementation, this would fetch data from the server
    // For now, we'll show a placeholder
    const modalBody = document.getElementById('analysisModalBody');
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading analysis details...</p>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('analysisModal')).show();
    
    // Simulate loading
    setTimeout(() => {
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Analysis Information</h6>
                    <p><strong>Analysis ID:</strong> #${analysisId}</p>
                    <p><strong>Status:</strong> <span class="badge bg-success">Completed</span></p>
                    <p><strong>Processing Time:</strong> 2.3 seconds</p>
                </div>
                <div class="col-md-6">
                    <h6>Image Preview</h6>
                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 150px;">
                        <i class="fas fa-image fa-2x text-muted"></i>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <h6>Prediction Results</h6>
                    <p>Detailed prediction results would be displayed here...</p>
                </div>
            </div>
        `;
    }, 1000);
}

// Explain analysis with XAI
function explainAnalysis(analysisId) {
    // Redirect to explainability page with analysis ID
    window.location.href = `/explainability?analysis_id=${analysisId}`;
}

// Delete analysis
function deleteAnalysis(analysisId) {
    if (confirm('Are you sure you want to delete this analysis? This action cannot be undone.')) {
        // In a real implementation, this would make an API call to delete the analysis
        alert('Delete functionality would be implemented here.');
    }
}

// Reanalyze image
function reanalyzeImage() {
    if (currentAnalysisId) {
        alert('Reanalysis functionality would be implemented here.');
    }
}

// Export history
function exportHistory() {
    // Generate CSV from visible rows
    const visibleRows = Array.from(document.querySelectorAll('.analysis-row'))
        .filter(row => row.style.display !== 'none');
    
    if (visibleRows.length === 0) {
        alert('No data to export');
        return;
    }
    
    const headers = ['ID', 'Filename', 'Predicted Disease', 'Confidence', 'Date'];
    const data = visibleRows.map(row => {
        const cells = row.querySelectorAll('td');
        return [
            cells[0].textContent.trim(),
            cells[2].textContent.trim(),
            cells[3].textContent.trim(),
            cells[4].querySelector('small').textContent.trim(),
            cells[5].textContent.trim()
        ];
    });
    
    const csv = [headers, ...data].map(row => 
        row.map(field => `"${field}"`).join(',')
    ).join('\n');
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', 'analysis_history.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}